package build

import (
	"bufio"
	"context"
	"fmt"
	"github.com/qiaoba0728/gene-analyse/internal/types"
	"github.com/qiaoba0728/gene-analyse/internal/utils"
	"go.uber.org/zap"
	"io"
	"os"
	"path"
	"strings"
)

const (
	oldIndex = "./index.html"
	index    = "./index.html.bak"
	logo     = "data:image/jpg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBAUEBAYFBQUGBgYHCQ4JCQgICRINDQoOFRIWFhUSFBQXGiEcFxgfGRQUHScdHyIjJSUlFhwpLCgkKyEkJST/2wBDAQYGBgkICREJCREkGBQYJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCT/wAARCAFRATIDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD6pooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKM0AFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFG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FFFABRRRQAUUUUAFIVGMYpaKAOf1zwhp2sKzGMQzEcSIMfnXnOs+F9R0V2MkZeHtIg4/GvZsUjIrDDAEV4uOySjitdpdzOdKMjwIDmlAI6167qngvStTBYxeTJ/fj4rkNU+HV/BlrRxOg7dGr5XFZBiaGsVdeRzyoSWxyAUE0Grlzoeo2X+ttJR77apuHT76Mv1FePKjODtONjJprcWikByKWpAaRSUtBpWFYKAM05YpGxhGOfatCz8P6lesBDaSHPc8CtKdCdR2hG41FsztpPSlVSTgDJFdnp/w3u5Sr3c6xL/dXk112l+EtL0sAxwh5B1d+TXs4XIMTWd5rlXmaqi3uefaJ4M1DViruhhh/vN1NehaL4VsNGUFEDy93brWyqhRhQAPQUtfVYLJ6GF1Su+7OiFJRDaAOKKU0lewaC0UUUAFFFFAARSUtBFACUUUUALRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFGKKKAGPEjj5lBqjcaDp11/rbSFs+qitGkzWcqUJfErismYMngjRZOttj6Gq7/D7RG/5YyD6Oa6bml5rmeXYV7019wuRdjmU+H+iJ/yzlP1c1Yj8F6NH/y7A/U1u4PrRg+tCy/DLaC+4ORdinbaPYWgAhtIlx3CCraoqjAAA9qdj1orohShH4VYqwlFFFagLRRRQAUUUUAFFFFABRRRQAUUUUAJRS4ooAKKKKACiiigAooooAKKKKAAGikpQaACiiigAooooAKKKKACiiigAooooAMUUUUAGKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAEooooAUGikpQaACijNGaACijNGaACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBKKKKACiiigAooooAKKKKAFopKWgAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBDRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQB//2coAMcU="
	template = `<td><p align="center">项目名称 </p></td>
		<td><p align="center">%s</p></td>
		<td><p align="center">合同编号 </p></td>
		<td><p align="center">%s</p></td>
	</tr>
	<tr>
		<td><p align="center">客户姓名 </p></td>
		<td><p align="center">%s</p></td>
		<td><p align="center">客户单位 </p></td>
		<td><p align="center">%s</p></td>
	</tr>
	<tr>`
)

type covert struct {
	contract string //合同名称
	name     string //客户姓名
	order    string //合同编号
	address  string //客户单位
	input    string
	output   string
	logger   *zap.Logger
}

func NewCovertPlugin(input, name, order, contract, address string, logger *zap.Logger) types.Plugin {
	return &covert{
		input:    input,
		name:     name,
		order:    order,
		contract: contract,
		address:  address,
		logger:   logger,
	}
}
func (c *covert) Build(ctx context.Context) error {
	c.logger.Info("build ", zap.String("contract", c.contract),
		zap.String("address", c.address),
		zap.String("order", c.order),
		zap.String("name", c.name))
	wd, _ := os.Getwd()
	err := c.buildBak()
	if err != nil {
		return err
	}
	c.logger.Info("build sucess", zap.String("old", path.Join(wd, c.order, index)),
		zap.String("new", path.Join(wd, c.order, oldIndex)))
	err = os.Rename(path.Join(wd, c.order, index), path.Join(wd, c.order, oldIndex))
	if err != nil {
		return err
	}
	utils.WritePngFile(path.Join(wd, c.order, "src", "images", "logo.png"), logo)
	c.logger.Info("build finished")
	return nil
}
func (c *covert) buildBak() error {
	var (
		err     error
		newLine string
	)
	c.logger.Info("unzip file ", zap.String("file", c.input))
	err = utils.UnZip(c.input, fmt.Sprintf("./%s", c.order))
	if err != nil {
		c.logger.Error("unzip fail", zap.Error(err))
		return err
	}
	c.logger.Info("unzip success", zap.String("name", c.order))
	in, err := os.Open(fmt.Sprintf("./%s/%s", c.order, "index.html"))
	if err != nil {
		return err
	}
	defer in.Close()
	out, err := os.OpenFile(fmt.Sprintf("./%s/%s", c.order, "index.html.bak"), os.O_RDWR|os.O_CREATE, 0766)
	if err != nil {
		return err
	}
	defer out.Close()

	br := bufio.NewReader(in)
	//start := false
	data := fmt.Sprintf(template, c.name, c.order, c.contract, c.address)
	for {
		line, _, err := br.ReadLine()
		if err == io.EOF {
			break
		}
		if err != nil {
			return err
		}
		newLine = string(line)
		c.logger.Info("exec before", zap.String("line", newLine))
		newLine = strings.Replace(newLine, "周梓良", "贺兴", -1)
		newLine = strings.Replace(newLine, "派森诺生物科技有限公司", "武汉增强子生物科技有限公司", -1)
		if strings.Contains(newLine, `项目名称`) {
			start := strings.Index(newLine, `<td><p align="center">项目名称 </p></td>`)
			end := strings.Index(newLine, `<td><p align="center">订单编号 </p></td>`)
			match := newLine[start:end]
			c.logger.Info("match", zap.String("str", match))
			newLine = strings.Replace(newLine, match, data, -1)
		}

		c.logger.Info("exec after", zap.String("line", newLine))
		_, err = out.WriteString(newLine)
		if err != nil {
			return err
		}
	}
	return nil
}
func (c *covert) Name() string {
	return "covert"
}
